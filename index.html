<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Twin-Me (àª—à«àªœàª°àª¾àª¤à«€)</title>
    <style>
        /* --- CSS STYLES --- */
        :root { --primary: #ea580c; --bg: #1a0500; --chat-bg: #2d0a00; --user-msg: #ea580c; --bot-msg: #431407; --text: #ffedd5; }
        
        body { 
            font-family: 'Mukta Vaani', 'Segoe UI', sans-serif; 
            background-color: var(--bg); color: var(--text); margin: 0; 
            height: 100dvh; display: flex; justify-content: center; overflow: hidden; 
        }

        .container { 
            width: 100%; max-width: 600px; height: 100%; 
            background: var(--chat-bg); display: flex; flex-direction: column; position: relative; 
        }
        
        /* SECURITY LAYER */
        #securityLayer { 
            position: absolute; inset: 0; background: #000; z-index: 2000; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; 
        }
        .scanner-ui { 
            width: 220px; height: 220px; border: 3px solid #ea580c; border-radius: 20px; 
            position: relative; overflow: hidden; box-shadow: 0 0 40px rgba(234, 88, 12, 0.4); margin-bottom: 20px;
        }
        .scan-line { 
            width: 100%; height: 3px; background: #fb923c; position: absolute; top: 0; 
            animation: scan 2.5s infinite; box-shadow: 0 0 15px #fb923c; 
        }
        @keyframes scan { 0% {top: 0;} 100% {top: 100%;} }
        
        #pinArea { display: none; margin-top: 15px; }
        #pinInput { 
            padding: 10px; font-size: 18px; text-align: center; letter-spacing: 5px; 
            background: #222; border: 1px solid #444; color: white; border-radius: 5px; width: 120px;
        }

        /* CHAT INTERFACE */
        .header { 
            padding: 15px; background: rgba(45, 10, 0, 0.95); border-bottom: 1px solid #5c1c0a; 
            display: flex; justify-content: space-between; align-items: center; z-index: 100;
        }
        .status-badge { font-size: 12px; background: #16a34a; color: #fff; padding: 2px 8px; border-radius: 10px; font-weight: bold; }

        .chat-box { 
            flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; 
        }
        .message { 
            max-width: 85%; padding: 12px 16px; border-radius: 15px; font-size: 1rem; line-height: 1.5; word-wrap: break-word; 
        }
        .bot { align-self: flex-start; background: var(--bot-msg); border-bottom-left-radius: 2px; border: 1px solid #7c2d12; }
        .user { align-self: flex-end; background: var(--user-msg); color: white; border-bottom-right-radius: 2px; }
        .message img { max-width: 100%; border-radius: 10px; margin-top: 10px; border: 1px solid #555; }

        /* INPUT AREA */
        .input-area { 
            padding: 10px; background: var(--chat-bg); border-top: 1px solid #5c1c0a; 
            display: flex; gap: 8px; align-items: center; 
        }
        input[type="text"] { 
            flex: 1; padding: 12px; background: #1a0500; border: 1px solid #5c1c0a; 
            color: white; border-radius: 25px; outline: none; font-size: 16px; 
        }
        .icon-btn { 
            background: #431407; color: white; border: 1px solid #5c1c0a; width: 45px; height: 45px; 
            border-radius: 50%; display: flex; justify-content: center; align-items: center; 
            font-size: 20px; cursor: pointer; transition: 0.2s;
        }
        .send-btn { background: var(--primary); border: none; }
        .recording { background: #ef4444 !important; animation: pulse 1s infinite; }
        @keyframes pulse { 0% {box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);} 70% {box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);} 100% {box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);} }

        /* SETTINGS MODAL */
        #settingsModal { 
            display: none; position: absolute; inset: 0; background: #1a0500; 
            z-index: 3000; padding: 20px; overflow-y: auto; 
        }
        .setting-group { margin-bottom: 20px; text-align: left; }
        .setting-group label { display: block; color: #fdba74; margin-bottom: 8px; font-weight: bold; }
        .setting-group input { 
            width: 100%; padding: 12px; background: #2d0a00; border: 1px solid #5c1c0a; 
            color: white; border-radius: 8px; box-sizing: border-box; font-size: 16px; 
        }
        .btn-full { 
            width: 100%; padding: 15px; border: none; border-radius: 10px; 
            font-size: 16px; font-weight: bold; color: white; margin-top: 10px; cursor: pointer; 
        }

        video { object-fit: cover; width: 100%; height: 100%; transform: scaleX(-1); }
    </style>
</head>
<body>

<div class="container">
    
    <div id="securityLayer">
        <h2 style="color: #ea580c; letter-spacing: 2px;">TWIN-ME <span style="font-size: 12px; color: #fff;">àª—à«àªœàª°àª¾àª¤à«€</span></h2>
        <div class="scanner-ui">
            <video id="scanVideo" autoplay playsinline muted></video>
            <div class="scan-line"></div>
        </div>
        
        <p id="scanStatus" style="color: #fdba74; font-family: sans-serif;">àª¶àª°à«‚ àª¥àªˆ àª°àª¹à«àª¯à«àª‚ àª›à«‡...</p>
        
        <div id="pinArea">
            <input type="password" id="pinInput" placeholder="PIN" maxlength="4">
            <button onclick="checkPin()" class="btn-full" style="width: auto; padding: 10px 20px; background: #ea580c; margin-left: 5px;">àª–à«‹àª²à«‹</button>
        </div>

        <div style="margin-top: 30px; display: flex; gap: 10px; width: 85%;">
            <button onclick="startScan()" class="btn-full" style="background: #ea580c;">àª«àª°à«€ àªªà«àª°àª¯àª¾àª¸</button>
            <button onclick="showSettings()" class="btn-full" style="background: #431407;">âš™ï¸ àª¸à«‡àªŸàª¿àª‚àª—à«àª¸</button>
        </div>
    </div>

    <div class="header">
        <div style="display: flex; align-items: center; gap: 10px;">
            <div style="width: 40px; height: 40px; background: #431407; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 20px;">ğŸ§‘â€ğŸ’»</div>
            <div>
                <div style="font-weight: bold;">àª¦à«‡àªµà«‡àª¨à«àª¦à«àª° (Twin)</div>
                <span class="status-badge">àª“àª¨àª²àª¾àª‡àª¨</span>
            </div>
        </div>
        <button onclick="showSettings()" style="background:none; border:none; font-size:24px; cursor:pointer;">âš™ï¸</button>
    </div>

    <div class="chat-box" id="chatBox">
        <div class="message bot">àªœàª¯ àª¶à«àª°à«€ àª•à«ƒàª·à«àª£! àª¹à«àª‚ àª¤à«ˆàª¯àª¾àª° àª›à«àª‚. àª¬à«‹àª²à«‹ àª¶à«àª‚ àª¸à«‡àªµàª¾ àª•àª°à«àª‚?</div>
    </div>

    <div class="input-area">
        <button class="icon-btn" onclick="captureVision()">ğŸ“·</button>
        <button class="icon-btn" id="micBtn" onclick="toggleVoice()">ğŸ¤</button>
        <input type="text" id="userInput" placeholder="àª…àª¹à«€àª‚ àª²àª–à«‹..." autocomplete="off">
        <button class="icon-btn send-btn" onclick="sendMessage()">â¤</button>
    </div>

    <div id="settingsModal">
        <h2 style="color:#ea580c; border-bottom: 1px solid #5c1c0a; padding-bottom: 10px;">àª¸à«‡àªŸàª¿àª‚àª—à«àª¸</h2>
        
        <div class="setting-group">
            <label>1. Gemini API Key</label>
            <input type="password" id="geminiKey" placeholder="Key àª…àª¹à«€àª‚ àªªà«‡àª¸à«àªŸ àª•àª°à«‹">
        </div>

        <div class="setting-group">
            <label>2. AI Model Name</label>
            <input type="text" id="customModel" value="gemini-2.5-flash">
            <div style="font-size: 12px; color: #888; margin-top: 5px;">
                àª¡àª¿àª«à«‹àª²à«àªŸ: gemini-2.5-flash
            </div>
        </div>

        <div class="setting-group">
            <label>3. àª¤àª®àª¾àª°à«‹ àªšàª¹à«‡àª°à«‹ (Security)</label>
            <div style="display:flex; gap:10px; align-items: center;">
                <img id="ownerPreview" src="" style="width: 60px; height: 60px; background: #333; border-radius: 10px; object-fit: cover;">
                <button onclick="captureOwner()" class="btn-full" style="flex:1; background: #ea580c; margin-top:0;">ğŸ“¸ àª«à«‹àªŸà«‹ àªªàª¾àª¡à«‹</button>
            </div>
            <input type="hidden" id="ownerData">
        </div>

        <div class="setting-group">
            <label>4. àª¬à«‡àª•àª…àªª PIN</label>
            <input type="text" id="backupPin" placeholder="Default: 0000" maxlength="4">
        </div>

        <button onclick="saveSettings()" class="btn-full" style="background: #16a34a;">àª¸à«‡àªµ àª•àª°à«‹ & àª°àª¿àª¸à«àªŸàª¾àª°à«àªŸ</button>
        <button onclick="closeSettings()" class="btn-full" style="background: #ef4444;">àª¬àª‚àª§ àª•àª°à«‹</button>
    </div>

</div>

<script>
    let config = { apiKey: '', ownerFace: null, pin: '0000', model: 'gemini-2.5-flash', history: [] };
    
    // --- SYSTEM PROMPT (GUJARATI ENFORCED) ---
    const SYSTEM_PROMPT = `
    àª¸à«‚àªšàª¨àª¾: àª¤à«àª‚ AI àª¨àª¥à«€. àª¤à«àª‚ 'àª¦à«‡àªµà«‡àª¨à«àª¦à«àª° àª°àª¾àª®àª¾àª¨à«àªœ' (Dev) àª›à«‡.
    àª­àª¾àª·àª¾: àª®àª¾àª¤à«àª° àª…àª¨à«‡ àª®àª¾àª¤à«àª° àª—à«àªœàª°àª¾àª¤à«€ (àª…àª¥àªµàª¾ àª—à«àªœàª°àª¾àª¤à«€+àª…àª‚àª—à«àª°à«‡àªœà«€ àª®àª¿àª•à«àª¸).
    àª¸à«àªµàª­àª¾àªµ: àª®à«ˆàª¤à«àª°à«€àªªà«‚àª°à«àª£, àª¸à«àªªàª·à«àªŸàªµàª•à«àª¤àª¾, àª†àª§à«àª¯àª¾àª¤à«àª®àª¿àª• àª…àª¨à«‡ àªŸà«‡àª•àª¨àª¿àª•àª².
    àª¨àª¿àª¯àª®: àª¸àª¾àª®à«‡ àªµàª¾àª³à«€ àªµà«àª¯àª•à«àª¤àª¿ àª—àª®à«‡ àª¤à«‡ àª­àª¾àª·àª¾àª®àª¾àª‚ àªªà«‚àª›à«‡ (English/Hindi), àª¤àª¾àª°à«‡ àªœàªµàª¾àª¬ àª—à«àªœàª°àª¾àª¤à«€àª®àª¾àª‚ àªœ àª†àªªàªµàª¾àª¨à«‹ àª›à«‡.
    àª‰àª¦àª¾àª¹àª°àª£: 
    User: Hello -> You: àªœàª¯ àª¶à«àª°à«€ àª•à«ƒàª·à«àª£! àª•à«‡àª® àª›à«‹?
    User: Who are you? -> You: àª¹à«àª‚ àª¦à«‡àªµà«‡àª¨à«àª¦à«àª° àª›à«àª‚, àª¤àª¾àª°à«‹ àª¡àª¿àªœàª¿àªŸàª² àª…àªµàª¤àª¾àª°.
    `;

    window.onload = () => {
        const saved = localStorage.getItem('twinMeGujarati');
        if (saved) {
            config = JSON.parse(saved);
            document.getElementById('geminiKey').value = config.apiKey;
            document.getElementById('backupPin').value = config.pin || '0000';
            document.getElementById('customModel').value = config.model || 'gemini-2.5-flash';
            document.getElementById('ownerData').value = config.ownerFace || '';
            if(config.ownerFace) document.getElementById('ownerPreview').src = "data:image/jpeg;base64," + config.ownerFace;
            
            if(config.apiKey) startScan();
            else document.getElementById('scanStatus').innerText = "âš ï¸ API Key àª¨àª¾àª–à«‹";
        } else {
            document.getElementById('scanStatus').innerText = "âš ï¸ àªªàª¹à«‡àª²àª¾ àª¸à«‡àªŸàª¿àª‚àª—à«àª¸ àª•àª°à«‹";
        }
    };

    // --- SECURITY ---
    async function startScan() {
        const video = document.getElementById('scanVideo');
        const status = document.getElementById('scanStatus');
        document.getElementById('pinArea').style.display = 'none';
        
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
            video.srcObject = stream;
            status.innerText = "àªšàª¹à«‡àª°à«‹ àªšàª•àª¾àª¸à«€ àª°àª¹à«àª¯à«àª‚ àª›à«‡...";
            status.style.color = "#fdba74";

            setTimeout(async () => {
                if (!config.apiKey) { status.innerText = "Key àª¨àª¥à«€ àª®àª³à«€"; return; }
                if (!config.ownerFace) { unlockApp(stream); return; }

                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                const currentFace = canvas.toDataURL('image/jpeg').split(',')[1];

                const result = await verifyIdentity(currentFace);

                if (result.match) {
                    status.innerText = "àª¸à«àªµàª¾àª—àª¤ àª›à«‡! âœ…";
                    status.style.color = "#22c55e";
                    setTimeout(() => unlockApp(stream), 1000);
                } else {
                    status.innerText = "àª“àª³àª– àª…àª®àª¾àª¨à«àª¯ âŒ";
                    status.style.color = "red";
                    document.getElementById('pinArea').style.display = 'block';
                }
            }, 2000);
        } catch (e) {
            status.innerText = "àª•à«‡àª®à«‡àª°àª¾ àªàª°àª°";
            document.getElementById('pinArea').style.display = 'block';
        }
    }

    async function verifyIdentity(faceBase64) {
        try {
            const response = await callGeminiAPI([
                { text: "Are these the same person? Reply YES or NO." },
                { inline_data: { mime_type: "image/jpeg", data: config.ownerFace } },
                { inline_data: { mime_type: "image/jpeg", data: faceBase64 } }
            ]);
            return { match: response.toUpperCase().includes("YES") };
        } catch(e) { return { match: false }; }
    }

    function checkPin() {
        if (document.getElementById('pinInput').value === config.pin) unlockApp(document.getElementById('scanVideo').srcObject);
        else alert("àª–à«‹àªŸà«‹ PIN àª›à«‡!");
    }

    function unlockApp(stream) {
        if(stream) stream.getTracks().forEach(t => t.stop());
        document.getElementById('securityLayer').style.display = 'none';
    }

    // --- CHAT ---
    async function sendMessage(imageData = null) {
        const input = document.getElementById('userInput');
        const text = input.value.trim();
        if (!text && !imageData) return;

        const chatBox = document.getElementById('chatBox');
        let userHtml = `<div class="message user">${text}`;
        if(imageData) userHtml += `<br><img src="data:image/jpeg;base64,${imageData}">`;
        userHtml += `</div>`;
        chatBox.innerHTML += userHtml;
        
        input.value = '';
        chatBox.scrollTop = chatBox.scrollHeight;

        const userParts = [];
        if(text) userParts.push({ text: text });
        if(imageData) userParts.push({ inline_data: { mime_type: "image/jpeg", data: imageData } });
        config.history.push({ role: "user", parts: userParts });

        const tempId = "typing-" + Date.now();
        chatBox.innerHTML += `<div class="message bot" id="${tempId}">àª²àª–à«€ àª°àª¹à«àª¯à«‹ àª›à«‡...</div>`;
        chatBox.scrollTop = chatBox.scrollHeight;

        try {
            const contextParts = [{ role: "user", parts: [{ text: SYSTEM_PROMPT }] }, ...config.history];
            const reply = await callGeminiChat(contextParts);
            document.getElementById(tempId).remove();
            addBotMessage(reply);
            speak(reply);
            config.history.push({ role: "model", parts: [{ text: reply }] });
        } catch (e) {
            document.getElementById(tempId).innerText = "Error: " + e.message;
        }
    }

    function addBotMessage(text) {
        const chatBox = document.getElementById('chatBox');
        let formatted = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
        chatBox.innerHTML += `<div class="message bot">${formatted}</div>`;
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // --- API & SETTINGS ---
    async function callGeminiChat(contents) {
        const modelToUse = config.model || 'gemini-2.5-flash';
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelToUse}:generateContent?key=${config.apiKey}`;
        const response = await fetch(url, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: contents })
        });
        const data = await response.json();
        if(data.error) throw new Error(data.error.message);
        return data.candidates[0].content.parts[0].text;
    }

    async function callGeminiAPI(parts) {
        const modelToUse = config.model || 'gemini-2.5-flash';
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelToUse}:generateContent?key=${config.apiKey}`;
        const response = await fetch(url, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ contents: [{ parts: parts }] })
        });
        const data = await response.json();
        return data.candidates[0].content.parts[0].text;
    }

    // --- VOICE & VISION ---
    function speak(text) {
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text.replace(/[*#]/g, ''));
        const voices = window.speechSynthesis.getVoices();
        // Try to get Hindi/Gujarati voice, else default
        const gujVoice = voices.find(v => v.lang.includes('gu')) || voices.find(v => v.lang.includes('hi'));
        if(gujVoice) utterance.voice = gujVoice;
        window.speechSynthesis.speak(utterance);
    }

    let recognition;
    if ('webkitSpeechRecognition' in window) {
        recognition = new webkitSpeechRecognition();
        recognition.continuous = false; recognition.lang = 'gu-IN';
        recognition.onstart = () => document.getElementById('micBtn').classList.add('recording');
        recognition.onend = () => { 
            document.getElementById('micBtn').classList.remove('recording'); 
            sendMessage(); 
        };
        recognition.onresult = (e) => document.getElementById('userInput').value = e.results[0][0].transcript;
    }
    function toggleVoice() { if(recognition) recognition.start(); else alert("Voice not supported"); }

    async function captureVision() {
        const video = document.createElement('video');
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            video.srcObject = stream; video.play();
            setTimeout(() => {
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                const base64 = canvas.toDataURL('image/jpeg').split(',')[1];
                stream.getTracks().forEach(t => t.stop());
                document.getElementById('userInput').value = "àª† àª«à«‹àªŸà«‹ àªµàª¿àª¶à«‡ àªœàª£àª¾àªµà«‹...";
                sendMessage(base64);
            }, 1000);
        } catch(e) { alert("Camera Error"); }
    }

    // --- SETTINGS UI ---
    function showSettings() { document.getElementById('settingsModal').style.display = 'block'; }
    function closeSettings() { document.getElementById('settingsModal').style.display = 'none'; }
    function saveSettings() {
        config.apiKey = document.getElementById('geminiKey').value;
        config.model = document.getElementById('customModel').value || 'gemini-2.5-flash';
        config.pin = document.getElementById('backupPin').value || '0000';
        config.ownerFace = document.getElementById('ownerData').value;
        localStorage.setItem('twinMeGujarati', JSON.stringify(config));
        location.reload();
    }
    async function captureOwner() {
        let video = document.getElementById('scanVideo');
        if(video.paused) {
            let s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
            video.srcObject = s; await new Promise(r => setTimeout(r, 1000));
        }
        let c = document.createElement('canvas'); c.width = video.videoWidth; c.height = video.videoHeight;
        c.getContext('2d').drawImage(video, 0, 0);
        let b64 = c.toDataURL('image/jpeg').split(',')[1];
        document.getElementById('ownerData').value = b64;
        document.getElementById('ownerPreview').src = "data:image/jpeg;base64," + b64;
        alert("àª«à«‹àªŸà«‹ àª²à«‡àªµàª¾àªˆ àª—àª¯à«‹!");
    }
    
    document.getElementById('userInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
</script>
</body>
</html>
