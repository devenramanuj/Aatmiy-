<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>àª†àª¤à«àª®à«€àª¯ àª®àª¿àª¤à«àª° (Auto Scan)</title>
    <style>
        /* --- CSS Styles --- */
        :root { --primary: #d97706; --bg: #fff7ed; --chat-bg: #ffffff; --user-msg: #d97706; --bot-msg: #f3f4f6; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); margin: 0; height: 100vh; display: flex; justify-content: center; align-items: center; }
        .container { width: 100%; max-width: 480px; height: 95vh; background: var(--chat-bg); border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow: hidden; border: 1px solid #fed7aa; position: relative; }
        
        .header { background: var(--primary); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .icon-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px; border-radius: 50%; cursor: pointer; }

        /* Settings Panel */
        .settings-panel { background: #2d3748; color: white; padding: 15px; display: none; position: absolute; top: 0; bottom: 0; left: 0; right: 0; z-index: 100; overflow-y: auto; }
        .settings-panel input { width: 95%; padding: 10px; margin: 5px 0 15px 0; border-radius: 5px; border: none; background: #4a5568; color: white; }
        .btn-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .action-btn { flex: 1; padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; }
        
        /* Auto Scan Overlay */
        #scanOverlay { display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 200; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .scanner-ring { width: 150px; height: 150px; border: 4px solid var(--primary); border-radius: 50%; position: relative; overflow: hidden; box-shadow: 0 0 20px var(--primary); animation: pulse 1.5s infinite; }
        .scanner-ring video { width: 100%; height: 100%; object-fit: cover; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(217, 119, 6, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(217, 119, 6, 0); } 100% { box-shadow: 0 0 0 0 rgba(217, 119, 6, 0); } }

        /* Chat Area */
        .chat-box { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; background-image: radial-gradient(#fed7aa 1px, transparent 1px); background-size: 20px 20px; }
        .message { max-width: 80%; padding: 12px 16px; border-radius: 15px; font-size: 0.95rem; line-height: 1.5; word-wrap: break-word; }
        .bot { align-self: flex-start; background: var(--bot-msg); color: #1f2937; }
        .user { align-self: flex-end; background: var(--user-msg); color: white; }
        .message img { max-width: 100%; border-radius: 10px; margin-top: 5px; }

        /* Footer */
        .input-area { padding: 10px; background: white; border-top: 1px solid #eee; display: flex; gap: 8px; align-items: center; }
        .round-btn { background: none; border: 1px solid #ddd; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; }
        input[type="text"] { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 25px; outline: none; }
        .send-btn { background: var(--primary); color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; }
        .active { background: #d1fae5; color: #059669; border-color: #059669; }
        #cameraPreviewHidden { display: none; } /* Hidden video element for capture */
    </style>
</head>
<body>

<div class="container">
    <div id="scanOverlay">
        <h2 style="margin-bottom: 20px;">àª“àª³àª– àªšàª•àª¾àª¸àª£à«€...</h2>
        <div class="scanner-ring">
            <video id="scanVideo" autoplay playsinline muted></video>
        </div>
        <p id="scanStatus" style="margin-top: 20px; color: #ccc;">àªšàª¹à«‡àª°à«‹ àª¸à«àª•à«‡àª¨ àª¥àªˆ àª°àª¹à«àª¯à«‹ àª›à«‡...</p>
        <button onclick="cancelScan()" style="margin-top: 30px; padding: 8px 20px; background: #444; color: white; border: none; border-radius: 20px; cursor: pointer;">Skip</button>
        <canvas id="scanCanvas" style="display:none;"></canvas>
    </div>

    <div class="header">
        <div><h2 style="margin:0;">àª†àª¤à«àª®à«€àª¯ àª®àª¿àª¤à«àª°</h2><span style="font-size:0.7rem;">Auto-Secure</span></div>
        <button class="icon-btn" onclick="toggleSettings()">âš™ï¸</button>
    </div>

    <div class="settings-panel" id="settingsPanel">
        <h3>Configuration</h3>
        <label>Gemini API Key</label> <input type="password" id="geminiKey">
        <label>Model Name</label> <input type="text" id="modelName" value="gemini-2.0-flash-exp">
        <label>ElevenLabs Key</label> <input type="password" id="elevenKey">
        <hr style="border-color:#555">
        <h3>Owner Face (Security)</h3>
        <img id="ownerPreview" src="" style="width:80px;height:80px;border-radius:50%;object-fit:cover;background:#ccc;display:block;margin:10px auto;">
        <div class="btn-group">
            <button class="action-btn" style="background:#3182ce" onclick="setOwnerFace()">ğŸ“· Set Face</button>
            <button class="action-btn" style="background:#e53e3e" onclick="clearFace()">ğŸ—‘ï¸ Clear</button>
        </div>
        <button class="action-btn" style="background:#48bb78; width:100%;" onclick="saveSettings()">âœ… Save & Close</button>
    </div>

    <div class="chat-box" id="chatBox"></div>
    <div id="typing" style="text-align:center; font-size:0.8rem; color:#666; display:none;">àª®àª¿àª¤à«àª° àªµàª¿àªšàª¾àª°à«€ àª°àª¹à«àª¯à«‹ àª›à«‡...</div>

    <div class="input-area">
        <button class="round-btn" onclick="manualPhoto()">ğŸ“·</button>
        <button class="round-btn" id="audioBtn" onclick="toggleAudio()">ğŸ”Š</button>
        <input type="text" id="userInput" placeholder="Message..." autocomplete="off">
        <button class="send-btn" onclick="sendMessage()">â¤</button>
    </div>
    
    <video id="manualVideo" style="display:none;" autoplay playsinline></video>
</div>

<script>
    let config = { geminiKey: '', modelName: 'gemini-2.5-flash', elevenKey: '', voiceId: '21m00Tcm4TlvDq8ikWAM', ownerFace: null };
    let isAudioOn = true;
    let stream = null;

    window.onload = () => {
        const saved = localStorage.getItem('mitraConfigAuto');
        if (saved) {
            config = JSON.parse(saved);
            document.getElementById('geminiKey').value = config.geminiKey;
            document.getElementById('modelName').value = config.modelName;
            document.getElementById('elevenKey').value = config.elevenKey;
            if(config.ownerFace) document.getElementById('ownerPreview').src = `data:image/jpeg;base64,${config.ownerFace}`;
            
            // àªœà«‹ àª•à«€ àª¸à«‡àªµ àª¹à«‹àª¯, àª¤à«‹ àª“àªŸà«‹ àª¸à«àª•à«‡àª¨ àª¶àª°à«‚ àª•àª°à«‹
            if (config.geminiKey) {
                startAutoScan();
            } else {
                addBotMsg("àª¨àª®àª¸à«àª¤à«‡! àªªàª¹à«‡àª²àª¾ âš™ï¸ àª¸à«‡àªŸàª¿àª‚àª—à«àª¸àª®àª¾àª‚ àªœàªˆàª¨à«‡ API Key àª¨àª¾àª–à«‹.");
            }
        } else {
            addBotMsg("àª¨àª®àª¸à«àª¤à«‡! àªªàª¹à«‡àª²àª¾ âš™ï¸ àª¸à«‡àªŸàª¿àª‚àª—à«àª¸àª®àª¾àª‚ àªœàªˆàª¨à«‡ API Key àª¨àª¾àª–à«‹.");
        }
        updateAudioBtn();
    };

    // --- AUTO SCAN LOGIC ---
    async function startAutoScan() {
        const overlay = document.getElementById('scanOverlay');
        const video = document.getElementById('scanVideo');
        const status = document.getElementById('scanStatus');
        
        overlay.style.display = 'flex';
        status.innerText = "àª•à«‡àª®à«‡àª°à«‹ àª¶àª°à«‚ àª¥àªˆ àª°àª¹à«àª¯à«‹ àª›à«‡...";

        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
            video.srcObject = stream;
            
            status.innerText = "àªšàª¹à«‡àª°à«‹ àª¸à«àª¥àª¿àª° àª°àª¾àª–à«‹...";
            
            // 2.5 àª¸à«‡àª•àª¨à«àª¡ àª°àª¾àª¹ àªœà«àª“ àªœà«‡àª¥à«€ àª•à«‡àª®à«‡àª°à«‹ àª«à«‹àª•àª¸ àª¥àª¾àª¯
            setTimeout(async () => {
                status.innerText = "àªµàª¿àª¶à«àª²à«‡àª·àª£ àªšàª¾àª²à«‡ àª›à«‡...";
                
                // Capture
                const canvas = document.getElementById('scanCanvas');
                canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                const currentFace = canvas.toDataURL('image/jpeg').split(',')[1];
                
                // Stop Camera
                stream.getTracks().forEach(t => t.stop());
                overlay.style.display = 'none';

                // Send to AI
                verifyUser(currentFace);

            }, 2500);

        } catch (e) {
            overlay.style.display = 'none';
            addBotMsg("àª“àªŸà«‹-àª¸à«àª•à«‡àª¨ àª¥àªˆ àª¶àª•à«àª¯à«àª‚ àª¨àª¥à«€ (àª•à«‡àª®à«‡àª°àª¾ àªªàª°àª®àª¿àª¶àª¨ àª†àªªà«‹). àª¤àª®à«‡ àª®à«‡àª¨à«àª¯à«àª…àª²à«€ àª®à«‡àª¸à«‡àªœ àª•àª°à«€ àª¶àª•à«‹ àª›à«‹.");
        }
    }

    function cancelScan() {
        if(stream) stream.getTracks().forEach(t => t.stop());
        document.getElementById('scanOverlay').style.display = 'none';
        addBotMsg("àª¸à«àª•à«‡àª¨ àª°àª¦ àª•àª°à«àª¯à«àª‚. àª¤àª®à«‡ àª®à«‡àª¸à«‡àªœ àª•àª°à«€ àª¶àª•à«‹ àª›à«‹.");
    }

    async function verifyUser(faceImage) {
        addBotMsg("ğŸ” àª“àª³àª– àªšàª•àª¾àª¸àª£à«€ àª¥àªˆ àª°àª¹à«€ àª›à«‡...");
        
        // àªœà«‹ àª®àª¾àª²àª¿àª•àª¨à«‹ àª«à«‹àªŸà«‹ àª¸à«‡àªŸ àª¹à«‹àª¯ àª¤à«‹ àª¸àª°àª–àª¾àª®àª£à«€, àª¨àª¹à«€àª‚àª¤àª° àª–àª¾àª²à«€ àª¸à«àªµàª¾àª—àª¤
        let prompt = "";
        const parts = [];

        if (config.ownerFace) {
            prompt = `
            SYSTEM: Compare Image 1 (Owner) and Image 2 (Current User).
            - IF MATCH: "àªœàª¯ àª¶à«àª°à«€ àª•à«ƒàª·à«àª£ àª¦à«‡àªµà«‡àª¨à«àª¦à«àª°àª­àª¾àªˆ! àª“àª³àª–à«€ àª—àª¯à«‹. àª†àªœàª¨à«‹ àª¶à«àª‚ àª•àª¾àª°à«àª¯àª•à«àª°àª® àª›à«‡?" (Be friendly).
            - IF NO MATCH: "àª¤àª®à«‡ àª•à«‹àª£ àª›à«‹? àª¹à«àª‚ àª¦à«‡àªµà«‡àª¨à«àª¦à«àª°àª­àª¾àªˆ àª¸àª¿àªµàª¾àª¯ àª•à«‹àªˆ àª¸àª¾àª¥à«‡ àªµàª¾àª¤ àª¨àª¥à«€ àª•àª°àª¤à«‹." (Stop access).
            `;
            parts.push({ text: prompt });
            parts.push({ inline_data: { mime_type: "image/jpeg", data: config.ownerFace } });
            parts.push({ inline_data: { mime_type: "image/jpeg", data: faceImage } });
        } else {
            prompt = `SYSTEM: This is the user. Look at his face and greet him warmly based on his expression. Say "àªœàª¯ àª¶à«àª°à«€ àª•à«ƒàª·à«àª£" and his name if you know it, or just "àª®àª¿àª¤à«àª°".`;
            parts.push({ text: prompt });
            parts.push({ inline_data: { mime_type: "image/jpeg", data: faceImage } });
        }

        callGeminiAPI(parts);
    }

    // --- GENERIC API CALL ---
    async function callGeminiAPI(parts) {
        document.getElementById('typing').style.display = 'block';
        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${config.modelName}:generateContent?key=${config.geminiKey}`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contents: [{ parts: parts }] })
            });
            const data = await res.json();
            document.getElementById('typing').style.display = 'none';
            
            if (data.error) addBotMsg(`Error: ${data.error.message}`);
            else {
                const text = data.candidates[0].content.parts[0].text;
                addBotMsg(text);
                if(isAudioOn) speak(text);
            }
        } catch(e) {
            document.getElementById('typing').style.display = 'none';
            addBotMsg("Network Error.");
        }
    }

    // --- MANUAL CHAT ---
    async function sendMessage() {
        const text = document.getElementById('userInput').value.trim();
        if(!text) return;
        
        // Show user msg
        const div = document.createElement('div'); div.className = 'message user'; div.innerText = text;
        document.getElementById('chatBox').appendChild(div);
        document.getElementById('userInput').value = '';

        // API Call
        const parts = [{ text: `System: àª¤à«àª‚ 'àª†àª¤à«àª®à«€àª¯ àª®àª¿àª¤à«àª°' àª›à«‡. User: ${text}` }];
        callGeminiAPI(parts);
    }
    
    // --- MANUAL PHOTO ---
    async function manualPhoto() {
        // Quick hidden capture for chat context
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
            const vid = document.getElementById('manualVideo');
            vid.srcObject = stream;
            vid.onloadedmetadata = () => {
                const cvs = document.createElement('canvas');
                cvs.width = vid.videoWidth; cvs.height = vid.videoHeight;
                cvs.getContext('2d').drawImage(vid,0,0);
                const img = cvs.toDataURL('image/jpeg').split(',')[1];
                stream.getTracks().forEach(t=>t.stop());
                
                // Send photo with generic query
                const div = document.createElement('div'); div.className='message user'; div.innerText = "(àª«à«‹àªŸà«‹ àª®à«‹àª•àª²à«àª¯à«‹)";
                document.getElementById('chatBox').appendChild(div);
                
                callGeminiAPI([
                    { text: "System: àª† àª«à«‹àªŸà«‹ àªœà«àª“ àª…àª¨à«‡ àª¤à«‡àª®àª¾àª‚ àª¶à«àª‚ àª›à«‡ àª¤à«‡ àªµàª¿àª¶à«‡ àª…àª¥àªµàª¾ àª®àª¾àª°àª¾ àª®à«‚àª¡ àªµàª¿àª¶à«‡ àªµàª¾àª¤ àª•àª°à«‹." },
                    { inline_data: { mime_type: "image/jpeg", data: img } }
                ]);
            };
        } catch(e) { alert("Camera Error"); }
    }

    // --- UTILS ---
    function addBotMsg(text) {
        const div = document.createElement('div'); div.className = 'message bot';
        div.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
        const box = document.getElementById('chatBox');
        box.appendChild(div); box.scrollTop = box.scrollHeight;
    }
    
    // --- SETTINGS ---
    function toggleSettings() { const p=document.getElementById('settingsPanel'); p.style.display=p.style.display==='block'?'none':'block'; }
    function saveSettings() {
        config.geminiKey = document.getElementById('geminiKey').value;
        config.modelName = document.getElementById('modelName').value;
        config.elevenKey = document.getElementById('elevenKey').value;
        localStorage.setItem('mitraConfigAuto', JSON.stringify(config));
        toggleSettings();
        alert('Saved! Page will reload.');
        location.reload(); // Reload to test auto-scan
    }
    async function setOwnerFace() {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
        const vid = document.createElement('video'); vid.srcObject = stream; vid.autoplay = true;
        // Wait briefly
        setTimeout(() => {
            const cvs = document.createElement('canvas'); cvs.width = 640; cvs.height = 480;
            cvs.getContext('2d').drawImage(vid, 0, 0, 640, 480);
            config.ownerFace = cvs.toDataURL('image/jpeg').split(',')[1];
            document.getElementById('ownerPreview').src = `data:image/jpeg;base64,${config.ownerFace}`;
            stream.getTracks().forEach(t=>t.stop());
        }, 1000);
    }
    function clearFace() { config.ownerFace=null; document.getElementById('ownerPreview').src=""; }
    
    // --- AUDIO ---
    function toggleAudio() { isAudioOn = !isAudioOn; window.speechSynthesis.cancel(); updateAudioBtn(); }
    function updateAudioBtn() { const b = document.getElementById('audioBtn'); b.innerText = isAudioOn ? 'ğŸ”Š' : 'ğŸ”‡'; isAudioOn ? b.classList.add('active') : b.classList.remove('active'); }
    async function speak(text) {
        let clean = text.replace(/[\*"`';_#]/g, '');
        if (config.elevenKey) {
             try {
                const r = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${config.voiceId}`, { method: 'POST', headers: {'Content-Type':'application/json','xi-api-key':config.elevenKey}, body: JSON.stringify({text:clean, model_id:"eleven_multilingual_v2"})});
                if(r.ok) { new Audio(URL.createObjectURL(await r.blob())).play(); return; }
            } catch(e){}
        }
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(clean);
        const v = window.speechSynthesis.getVoices().find(v=>v.lang.includes('gu'));
        if(v) u.voice = v;
        window.speechSynthesis.speak(u);
    }
</script>
</body>
</html>
