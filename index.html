<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Twin-Me (Ultimate AI)</title>
    <style>
        /* --- THEME & COLORS --- */
        :root { --primary: #ea580c; --bg: #0f172a; --chat-bg: #1e293b; --user-msg: #ea580c; --bot-msg: #334155; --text: #e2e8f0; --code-bg: #0d1117; }
        
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; height: 100dvh; display: flex; justify-content: center; overflow: hidden; }
        .container { width: 100%; max-width: 600px; height: 100%; background: var(--chat-bg); display: flex; flex-direction: column; position: relative; }
        
        /* HEADER */
        .header { padding: 15px; background: rgba(15, 23, 42, 0.95); border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; z-index: 100; backdrop-filter: blur(10px); }
        .status-badge { font-size: 10px; background: #22c55e; color: #000; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-left: 5px; }

        /* CHAT AREA */
        .chat-box { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }
        
        .message { max-width: 85%; padding: 12px 16px; border-radius: 15px; font-size: 0.95rem; line-height: 1.6; word-wrap: break-word; position: relative; }
        .bot { align-self: flex-start; background: var(--bot-msg); border: 1px solid #475569; border-bottom-left-radius: 2px; }
        .user { align-self: flex-end; background: var(--user-msg); color: white; border-bottom-right-radius: 2px; }
        
        /* CODE BLOCK STYLING */
        pre { background: var(--code-bg); padding: 10px; border-radius: 8px; overflow-x: auto; border: 1px solid #30363d; margin: 10px 0; }
        code { font-family: 'Consolas', 'Courier New', monospace; font-size: 0.85rem; color: #58a6ff; }
        .source-link { display: block; font-size: 0.75rem; color: #94a3b8; margin-top: 5px; text-decoration: none; border-top: 1px solid #475569; padding-top: 5px; }

        /* INPUT AREA */
        .input-area { padding: 10px; background: var(--chat-bg); border-top: 1px solid #334155; display: flex; gap: 8px; align-items: center; }
        input[type="text"] { flex: 1; padding: 12px; background: #0f172a; border: 1px solid #334155; color: white; border-radius: 25px; outline: none; font-size: 16px; transition: 0.3s; }
        input:focus { border-color: var(--primary); }
        .icon-btn { background: #334155; color: white; width: 45px; height: 45px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 20px; border:none; cursor: pointer; transition: 0.2s; }
        .icon-btn:active { transform: scale(0.9); }
        .send-btn { background: var(--primary); }
        .recording { background: #ef4444 !important; animation: pulse 1s infinite; }
        @keyframes pulse { 0% {box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);} 70% {box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);} 100% {box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);} }

        /* SETTINGS MODAL */
        #settingsModal { display: none; position: absolute; inset: 0; background: #0f172a; z-index: 3000; padding: 20px; overflow-y: auto; }
        .setting-group { margin-bottom: 20px; text-align: left; }
        .setting-group label { display: block; color: #ea580c; margin-bottom: 8px; font-weight: bold; font-size: 0.9rem; }
        .setting-group input, .setting-group select, .setting-group textarea { width: 100%; padding: 12px; background: #1e293b; border: 1px solid #334155; color: white; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .btn-full { width: 100%; padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; color: white; margin-top: 10px; cursor: pointer; }
        
        /* HIDDEN ELEMENTS */
        #fileInput { display: none; }
        video { display:none; }
    </style>
</head>
<body>

<div class="container">
    
    <div class="header">
        <div style="display: flex; flex-direction: column;">
            <div style="font-weight: bold; color: white; font-size: 1.1rem;">àª¦à«‡àªµà«‡àª¨à«àª¦à«àª° (Twin AI)</div>
            <div style="font-size: 0.75rem; color: #94a3b8;">Online <span id="modelDisplay"></span></div>
        </div>
        <button onclick="showSettings()" style="background:none; border:none; font-size:24px; cursor:pointer;">âš™ï¸</button>
    </div>

    <div class="chat-box" id="chatBox"></div>

    <div class="input-area">
        <button class="icon-btn" onclick="document.getElementById('fileInput').click()">ğŸ“</button>
        <button class="icon-btn" onclick="captureVision()">ğŸ“·</button>
        <button class="icon-btn" id="micBtn" onclick="toggleVoice()">ğŸ¤</button>
        <input type="text" id="userInput" placeholder="àª²àª–à«‹..." autocomplete="off">
        <button class="icon-btn send-btn" onclick="sendMessage()">â¤</button>
    </div>

    <input type="file" id="fileInput" onchange="handleFileUpload(this)">

    <div id="settingsModal">
        <h2 style="color:#ea580c; border-bottom: 1px solid #334155; padding-bottom: 10px;">Twin Configuration</h2>
        
        <div class="setting-group">
            <label>1. Gemini API Key (Required)</label>
            <input type="password" id="geminiKey" placeholder="AI Studio Key">
        </div>

        <div class="setting-group">
            <label>2. AI Model (Google Search Enabled)</label>
            <select id="modelSelect">
                <option value="gemini-2.0-flash-exp" selected>gemini-2.0-flash-exp (Best for Search)</option>
                <option value="gemini-2.5-flash">gemini-2.5-flash</option>
                <option value="gemini-1.5-pro">gemini-1.5-pro</option>
                <option value="gemini-2.0-flash">gemini-2.0-flash</option>
            </select>
        </div>

        <div class="setting-group">
            <label>3. System Instructions (Persona)</label>
            <textarea id="systemPrompt" rows="3">You are Devendra Ramanuj. Speak Gujarati/English mix. Concise answers.</textarea>
        </div>

        <div class="setting-group">
            <label>4. ElevenLabs Key (Optional)</label>
            <input type="password" id="elevenKey" placeholder="For Realistic Voice">
        </div>
        
        <div class="setting-group">
            <label>5. Voice ID</label>
            <input type="text" id="voiceId" value="pNInz6obpgDQGcFmaJgB">
        </div>

        <div class="setting-group">
             <button onclick="clearMemory()" class="btn-full" style="background: #ef4444; margin-top:0;">ğŸ—‘ï¸ Clear Chat History</button>
        </div>

        <button onclick="saveSettings()" class="btn-full" style="background: #16a34a;">Save & Close</button>
        <button onclick="closeSettings()" class="btn-full" style="background: #334155;">Cancel</button>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    let config = { 
        apiKey: '', 
        elevenKey: '', 
        voiceId: 'pNInz6obpgDQGcFmaJgB', 
        model: 'gemini-2.0-flash-exp', 
        systemPrompt: 'You are Devendra Ramanuj. Speak Gujarati/English mix.',
        history: [] 
    };
    let currentFile = null;

    // --- INITIALIZATION ---
    window.onload = () => {
        const saved = localStorage.getItem('twinMeUltV4');
        if (saved) {
            config = JSON.parse(saved);
            document.getElementById('geminiKey').value = config.apiKey;
            document.getElementById('modelSelect').value = config.model || 'gemini-2.0-flash-exp';
            document.getElementById('systemPrompt').value = config.systemPrompt || 'You are Devendra Ramanuj. Speak Gujarati/English mix.';
            document.getElementById('elevenKey').value = config.elevenKey || '';
            document.getElementById('voiceId').value = config.voiceId || 'pNInz6obpgDQGcFmaJgB';
            
            document.getElementById('modelDisplay').innerText = `| ${config.model.replace('gemini-', '')}`;

            if(config.history.length > 0) renderHistory();
            else addMessageToUI("bot", "àªœàª¯ àª¶à«àª°à«€ àª•à«ƒàª·à«àª£! àª¹à«àª‚ àª²àª¾àªˆàªµ àª›à«àª‚. àªˆàª¨à«àªŸàª°àª¨à«‡àªŸ àª¸àª°à«àªš, àª«àª¾àªˆàª², àª•à«‹àª¡ - àª¬àª§à«àª‚ àª¤à«ˆàª¯àª¾àª° àª›à«‡.");

            if(!config.apiKey) showSettings();
        } else {
            showSettings();
        }
    };

    // --- MAIN CHAT LOGIC (WITH GOOGLE SEARCH) ---
    async function sendMessage(img = null) {
        const input = document.getElementById('userInput');
        let text = input.value.trim();
        
        if (!text && !img && !currentFile) return;

        // Check Local Commands
        if (checkLocalCommands(text)) { input.value = ''; return; }

        // UI Update
        addMessageToUI('user', text, img || (currentFile?.type?.startsWith('image') ? currentFile.data : null));
        input.value = '';

        // Prepare History Payload
        const userParts = [{ text: text }];
        if(img) userParts.push({ inline_data: { mime_type: "image/jpeg", data: img } });
        if(currentFile) {
            if(currentFile.mime.startsWith('image/')) userParts.push({ inline_data: { mime_type: currentFile.mime, data: currentFile.data } });
            else userParts.push({ text: `\n\n[FILE: ${currentFile.name}]\n${currentFile.data}\n` });
            currentFile = null;
        }

        config.history.push({ role: "user", parts: userParts });

        // Show Typing with "Searching" hint
        const tmp = "t-" + Date.now();
        document.getElementById('chatBox').innerHTML += `<div class="message bot" id="${tmp}">Thinking...</div>`;
        scrollToBottom();

        try {
            const now = new Date();
            const dynamicPrompt = `${config.systemPrompt} Current Time: ${now.toLocaleString()}.`;
            
            const payload = {
                contents: [{ role: "user", parts: [{ text: dynamicPrompt }] }, ...config.history],
                // GOOGLE SEARCH ENABLED
                tools: [{ google_search: {} }] 
            };
            
            const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${config.model}:generateContent?key=${config.apiKey}`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const d = await r.json();
            
            if(d.error) throw new Error(d.error.message);
            
            let reply = d.candidates[0].content.parts[0].text;
            
            // Check for Grounding (Search Sources)
            const grounding = d.candidates[0].groundingMetadata;
            if(grounding && grounding.searchEntryPoint) {
                 reply += `\n\nğŸ” ${grounding.searchEntryPoint.renderedContent}`;
            }

            document.getElementById(tmp).remove();
            addMessageToUI('bot', reply);
            
            config.history.push({ role: "model", parts: [{ text: reply }] });
            localStorage.setItem('twinMeUltV4', JSON.stringify(config));
            
            speak(reply);

        } catch (e) { document.getElementById(tmp).innerText = "Error: " + e.message; }
    }

    // --- UI RENDERING (CODE HIGHLIGHTING) ---
    function addMessageToUI(role, text, img = null) {
        const box = document.getElementById('chatBox');
        
        // Basic Formatting (Bold, Code Blocks)
        let formatted = text
            .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>') // Code Blocks
            .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>') // Bold
            .replace(/\n/g, '<br>'); // Newlines

        let h = `<div class="message ${role}">${formatted}`;
        if(img) h += `<br><img src="data:image/jpeg;base64,${img}">`;
        h += `</div>`;
        
        box.innerHTML += h;
        scrollToBottom();
    }

    function scrollToBottom() {
        const box = document.getElementById('chatBox');
        box.scrollTop = box.scrollHeight;
    }

    function renderHistory() {
        const box = document.getElementById('chatBox');
        box.innerHTML = '';
        config.history.forEach(msg => {
            if(msg.role === 'user' && msg.parts[0].text.includes("INSTRUCTIONS:")) return;
            let text = msg.parts[0].text || "";
            if(text.includes("[FILE:")) text = "[File Attached]";
            addMessageToUI(msg.role === 'user' ? 'user' : 'bot', text);
        });
    }

    // --- FILE UPLOAD ---
    function handleFileUpload(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            currentFile = { name: file.name, data: e.target.result.split(',')[1] || e.target.result, mime: file.type };
            document.getElementById('userInput').value = `[File: ${file.name}] attached.`;
        };
        if (file.type.startsWith('image/')) reader.readAsDataURL(file); else reader.readAsText(file);
    }

    // --- COMMANDS ---
    function checkLocalCommands(text) {
        const lower = text.toLowerCase();
        if (lower.includes("clear chat")) { clearMemory(); return true; }
        if (lower.includes("open whatsapp")) { window.location.href = "whatsapp://"; return true; }
        if (lower.startsWith("search ")) { 
            window.open(`https://www.google.com/search?q=${text.replace("search ", "")}`, '_blank'); return true; 
        }
        return false;
    }

    // --- VOICE & SETTINGS ---
    function clearMemory() {
        if(confirm("Delete all history?")) {
            config.history = []; localStorage.setItem('twinMeUltV4', JSON.stringify(config));
            document.getElementById('chatBox').innerHTML = '';
        }
    }
    async function speak(text) {
        const clean = text.replace(/[*#`]/g, '').replace(/[\u{1F600}-\u{1F64F}]/gu, ""); 
        if (config.elevenKey) {
            try {
                const r = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${config.voiceId}`, {
                    method: 'POST', headers: { 'xi-api-key': config.elevenKey, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: clean, model_id: "eleven_multilingual_v2" })
                });
                if (r.ok) { new Audio(URL.createObjectURL(await r.blob())).play(); return; }
            } catch (e) {}
        }
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(clean);
        u.voice = window.speechSynthesis.getVoices().find(v=>v.lang.includes('gu')) || window.speechSynthesis.getVoices().find(v=>v.lang.includes('hi'));
        window.speechSynthesis.speak(u);
    }
    
    function showSettings() { document.getElementById('settingsModal').style.display = 'block'; }
    function closeSettings() { document.getElementById('settingsModal').style.display = 'none'; }
    function saveSettings() {
        config.apiKey = document.getElementById('geminiKey').value;
        config.elevenKey = document.getElementById('elevenKey').value;
        config.voiceId = document.getElementById('voiceId').value;
        config.model = document.getElementById('modelSelect').value;
        config.systemPrompt = document.getElementById('systemPrompt').value;
        localStorage.setItem('twinMeUltV4', JSON.stringify(config));
        location.reload();
    }

    // --- VISION & MIC ---
    let rec;
    if ('webkitSpeechRecognition' in window) {
        rec = new webkitSpeechRecognition(); rec.continuous=false; rec.lang='gu-IN';
        rec.onstart=()=>document.getElementById('micBtn').classList.add('recording');
        rec.onend=()=>{document.getElementById('micBtn').classList.remove('recording'); sendMessage();};
        rec.onresult=(e)=>document.getElementById('userInput').value=e.results[0][0].transcript;
    }
    function toggleVoice(){rec?rec.start():alert("Voice not supported");}

    async function captureVision(){
        const v=document.createElement('video');
        try {
            const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
            v.srcObject=s; v.play();
            setTimeout(()=>{
                const c=document.createElement('canvas'); c.width=v.videoWidth; c.height=v.videoHeight;
                c.getContext('2d').drawImage(v,0,0);
                const b64=c.toDataURL('image/jpeg').split(',')[1]; s.getTracks().forEach(t=>t.stop());
                document.getElementById('userInput').value="Describe this..."; sendMessage(b64);
            },1000);
        } catch(e){ alert("Camera Error"); }
    }
    document.getElementById('userInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
</script>
</body>
</html>
