<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Twin-Me (v2.5)</title>
    <style>
        /* --- Styles --- */
        :root { --primary: #2563eb; --bg: #0f172a; --chat-bg: #1e293b; --user-msg: #3b82f6; --bot-msg: #334155; --text: #e2e8f0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; height: 100dvh; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        .container { width: 100%; height: 100%; background: var(--chat-bg); display: flex; flex-direction: column; position: relative; }
        
        /* Security Overlay */
        #securityLayer { position: absolute; inset: 0; background: #000; z-index: 900; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .scanner-ui { width: 200px; height: 200px; border: 2px solid #2563eb; border-radius: 20px; position: relative; overflow: hidden; box-shadow: 0 0 30px rgba(37, 99, 235, 0.3); margin-bottom: 20px; }
        .scan-line { width: 100%; height: 2px; background: #0f0; position: absolute; top: 0; animation: scan 2s infinite; box-shadow: 0 0 10px #0f0; }
        @keyframes scan { 0% {top: 0;} 100% {top: 100%;} }
        
        /* PIN Input */
        #pinArea { display: none; margin-top: 15px; }
        #pinInput { padding: 10px; border-radius: 5px; border: 1px solid #333; background: #222; color: white; width: 100px; text-align: center; letter-spacing: 5px; }

        /* Chat Area */
        .chat-box { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .message { max-width: 85%; padding: 12px 16px; border-radius: 12px; font-size: 1rem; line-height: 1.5; word-wrap: break-word; }
        .bot { align-self: flex-start; background: var(--bot-msg); border-bottom-left-radius: 2px; }
        .user { align-self: flex-end; background: var(--user-msg); color: white; border-bottom-right-radius: 2px; }
        .input-area { padding: 10px; background: var(--chat-bg); border-top: 1px solid #334155; display: flex; gap: 10px; align-items: center; }
        input[type="text"] { flex: 1; padding: 12px; background: #0f172a; border: 1px solid #334155; color: white; border-radius: 25px; outline: none; font-size: 16px; }
        .send-btn { background: var(--primary); color: white; border: none; width: 45px; height: 45px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 20px; }
        
        /* Settings */
        #settingsModal { display: none; position: absolute; inset: 0; background: #0f172a; z-index: 1000; padding: 20px; overflow-y: auto; }
        .setting-group { margin-bottom: 20px; text-align: left; }
        .setting-group label { display: block; color: #94a3b8; margin-bottom: 8px; }
        .setting-group input { width: 100%; padding: 12px; background: #1e293b; border: 1px solid #334155; color: white; border-radius: 8px; box-sizing: border-box; }
        .btn-full { width: 100%; padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; color: white; margin-top: 10px; cursor: pointer; }
        video { object-fit: cover; width: 100%; height: 100%; transform: scaleX(-1); }
    </style>
</head>
<body>

<div class="container">
    
    <div id="securityLayer">
        <h2 style="color: #fff;">TWIN-ME <span style="font-size: 12px; color: #0f0;">v2.5</span></h2>
        <div class="scanner-ui">
            <video id="scanVideo" autoplay playsinline muted></video>
            <div class="scan-line"></div>
        </div>
        <p id="scanStatus" style="color: #94a3b8; font-family: monospace; font-size: 12px;">INITIALIZING...</p>
        
        <div id="pinArea">
            <input type="password" id="pinInput" placeholder="PIN" maxlength="4">
            <button onclick="checkPin()" style="padding: 10px; background: #2563eb; color: white; border: none; border-radius: 5px;">GO</button>
        </div>

        <div style="margin-top: 20px; display: flex; gap: 10px; width: 80%;">
            <button onclick="startScan()" class="btn-full" style="background: #2563eb;">RETRY</button>
            <button onclick="showSettings()" class="btn-full" style="background: #475569;">‚öôÔ∏è SETUP</button>
        </div>
    </div>

    <div style="padding: 15px; background: rgba(30,41,59,0.9); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333;">
        <div style="font-weight: bold;">Devendra (Twin)</div>
        <button onclick="showSettings()" style="background:none; border:none; font-size:20px;">‚öôÔ∏è</button>
    </div>

    <div class="chat-box" id="chatBox"></div>

    <div class="input-area">
        <input type="text" id="userInput" placeholder="Message..." autocomplete="off">
        <button class="send-btn" onclick="sendMessage()">‚û§</button>
    </div>

    <div id="settingsModal">
        <h2 style="color:white; margin-bottom: 20px;">Configuration</h2>
        
        <div class="setting-group">
            <label>Gemini API Key</label>
            <input type="password" id="geminiKey" placeholder="Paste Key Here">
        </div>

        <div class="setting-group">
            <label>Model Name (Advanced)</label>
            <input type="text" id="modelName" value="gemini-2.5-flash">
        </div>

        <div class="setting-group">
            <label>Backup PIN (4 Digits)</label>
            <input type="text" id="backupPin" placeholder="Ex: 1234" maxlength="4">
        </div>

        <div class="setting-group">
            <label>Owner Face</label>
            <div style="display:flex; gap:10px; align-items: center;">
                <img id="ownerPreview" src="" style="width: 60px; height: 60px; background: #333; border-radius: 50%; object-fit: cover;">
                <button onclick="captureOwner()" class="btn-full" style="flex:1; background: #3b82f6;">üì∏ Capture Owner</button>
            </div>
            <input type="hidden" id="ownerData">
        </div>

        <button onclick="saveSettings()" class="btn-full" style="background: #22c55e;">SAVE & REBOOT</button>
        <button onclick="closeSettings()" class="btn-full" style="background: #ef4444;">CLOSE</button>
    </div>

</div>

<script>
    // Config with Model Name support
    let config = { apiKey: '', ownerFace: null, pin: '0000', history: [], model: 'gemini-2.5-flash' };
    const SYSTEM_PROMPT = `You are Twin-Me. Identity: Software Developer, Spiritual. Tone: Friendly, Gujarati/English mix. Concise.`;

    window.onload = () => {
        const saved = localStorage.getItem('twinMePro');
        if (saved) {
            config = JSON.parse(saved);
            document.getElementById('geminiKey').value = config.apiKey;
            document.getElementById('backupPin').value = config.pin || '0000';
            // Load custom model if saved, else default to 2.5
            document.getElementById('modelName').value = config.model || 'gemini-2.5-flash';
            document.getElementById('ownerData').value = config.ownerFace || '';
            if(config.ownerFace) document.getElementById('ownerPreview').src = "data:image/jpeg;base64," + config.ownerFace;
            
            if(config.apiKey) startScan();
            else document.getElementById('scanStatus').innerText = "PLEASE SETUP API KEY";
        } else {
            document.getElementById('scanStatus').innerText = "PLEASE SETUP API KEY";
        }
    };

    // --- FACE SCAN ---
    async function startScan() {
        const video = document.getElementById('scanVideo');
        const status = document.getElementById('scanStatus');
        document.getElementById('pinArea').style.display = 'none';
        
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
            video.srcObject = stream;
            status.innerText = "SCANNING...";
            status.style.color = "#00d2ff";

            setTimeout(async () => {
                if (!config.apiKey) { status.innerText = "API KEY MISSING"; return; }
                if (!config.ownerFace) { unlockApp(stream); return; }

                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                const currentFace = canvas.toDataURL('image/jpeg').split(',')[1];

                const result = await verifyIdentity(currentFace);

                if (result.match) {
                    status.innerText = "UNLOCKED ‚úÖ";
                    status.style.color = "#22c55e";
                    setTimeout(() => unlockApp(stream), 1000);
                } else {
                    status.innerText = `MISMATCH: ${result.reason}`; 
                    status.style.color = "red";
                    document.getElementById('pinArea').style.display = 'block';
                }
            }, 2500);
        } catch (e) {
            status.innerText = "CAMERA ERROR";
            document.getElementById('pinArea').style.display = 'block';
        }
    }

    async function verifyIdentity(faceBase64) {
        // Using dynamic model name from config
        const modelName = config.model || 'gemini-2.5-flash';
        try {
            const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${config.apiKey}`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    contents: [{ parts: [
                        { text: "Compare these two images strictly visually. Do they appear to be the same person? Reply YES or NO." },
                        { inline_data: { mime_type: "image/jpeg", data: config.ownerFace } },
                        { inline_data: { mime_type: "image/jpeg", data: faceBase64 } }
                    ]}] 
                })
            });
            const d = await r.json();
            
            if(d.error) return { match: false, reason: "Model Error (Check Version)" };

            const text = d.candidates[0].content.parts[0].text.trim().toUpperCase();
            if (text.includes("YES")) return { match: true };
            return { match: false, reason: "Face Not Recognized" };
        } catch(e) {
            return { match: false, reason: "Network Error" };
        }
    }

    function checkPin() {
        if (document.getElementById('pinInput').value === config.pin) {
            const video = document.getElementById('scanVideo');
            if(video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
            document.getElementById('securityLayer').style.display = 'none';
            addBotMessage("PIN Accepted. Welcome!");
        } else {
            alert("WRONG PIN!");
        }
    }

    function unlockApp(stream) {
        if(stream) stream.getTracks().forEach(t => t.stop());
        document.getElementById('securityLayer').style.display = 'none';
        addBotMessage("‡™ú‡™Ø ‡™∂‡´ç‡™∞‡´Ä ‡™ï‡´É‡™∑‡´ç‡™£! ‡™µ‡´á‡™≤‡™ï‡™Æ ‡™¨‡´á‡™ï.");
    }

    // --- SETTINGS ---
    function showSettings() { document.getElementById('settingsModal').style.display = 'block'; }
    function closeSettings() { document.getElementById('settingsModal').style.display = 'none'; }
    
    function saveSettings() {
        config.apiKey = document.getElementById('geminiKey').value;
        config.pin = document.getElementById('backupPin').value || '0000';
        config.model = document.getElementById('modelName').value || 'gemini-2.5-flash';
        config.ownerFace = document.getElementById('ownerData').value;
        localStorage.setItem('twinMePro', JSON.stringify(config));
        location.reload();
    }

    async function captureOwner() {
        const video = document.getElementById('scanVideo');
        if(video.paused || !video.srcObject) {
            const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
            video.srcObject = s;
            await new Promise(r => setTimeout(r, 500));
        }
        const c = document.createElement('canvas');
        c.width = video.videoWidth; c.height = video.videoHeight;
        c.getContext('2d').drawImage(video, 0, 0);
        const b64 = c.toDataURL('image/jpeg').split(',')[1];
        document.getElementById('ownerData').value = b64;
        document.getElementById('ownerPreview').src = "data:image/jpeg;base64," + b64;
        alert("Face Captured! Click SAVE.");
    }

    // --- CHAT ---
    async function sendMessage() {
        const i = document.getElementById('userInput');
        const t = i.value.trim();
        if(!t) return;
        
        const box = document.getElementById('chatBox');
        box.innerHTML += `<div class="message user">${t}</div>`;
        i.value = '';
        box.scrollTop = box.scrollHeight;
        
        config.history.push({ role: "user", parts: [{ text: t }] });
        
        const tempId = Date.now();
        box.innerHTML += `<div class="message bot" id="${tempId}">...</div>`;
        box.scrollTop = box.scrollHeight;

        const modelName = config.model || 'gemini-2.5-flash';

        try {
            const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${config.apiKey}`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contents: [{role:"user", parts:[{text:SYSTEM_PROMPT}]}, ...config.history] })
            });
            const d = await r.json();
            
            if(d.error) {
                document.getElementById(tempId).innerText = `Error: ${d.error.message}`;
                return;
            }

            const reply = d.candidates[0].content.parts[0].text;
            document.getElementById(tempId).remove();
            addBotMessage(reply);
            config.history.push({ role: "model", parts: [{ text: reply }] });
        } catch(e) { document.getElementById(tempId).innerText = "Network Error"; }
    }

    function addBotMessage(text) {
        const box = document.getElementById('chatBox');
        box.innerHTML += `<div class="message bot">${text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')}</div>`;
        box.scrollTop = box.scrollHeight;
    }
</script>
</body>
</html>
